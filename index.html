<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>A-Frame + GVRM example</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <!-- Three + GVRM (ESM via importmap) -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.min.js",
          "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2.1.0/lib/three-vrm.module.js",
          "gaussian-splats-3d": "https://naruya.github.io/gs-edit/lib/gaussian-splats-3d.module.js",
          "jszip": "https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm",
          "gvrm": "https://naruya.github.io/gs-edit/lib/gaussian-vrm.min.js"
        }
      }
    </script>

    <!-- GVRM A-Frame component -->
    <script type="module">
      import * as THREE from 'three';
      import { GVRM } from 'gvrm';

      AFRAME.registerComponent('gvrm-avatar', {
        schema: {
          src:   { type: 'string', default: './sample.gvrm' },
          anim:  { type: 'string', default: './Idle.fbx' }
        },

        init: function () {
          const sceneEl   = this.el.sceneEl;

          // A-Frame's underlying THREE objects
          this.threeScene   = sceneEl.object3D;
          this.renderer     = sceneEl.renderer;
          this.camera       = sceneEl.camera && sceneEl.camera.el.getObject3D('camera');

          this.gvrm = null;
          this.loaded = false;

          // If camera isn't ready yet, wait for it
          if (!this.camera) {
            sceneEl.addEventListener('loaded', () => {
              this.camera = sceneEl.camera.el.getObject3D('camera');
              this.loadGvrm();
            });
          } else {
            this.loadGvrm();
          }
        },

        async loadGvrm () {
          if (!this.renderer || !this.camera || !this.threeScene) return;

          // 1/3: load GVRM
          this.gvrm = await GVRM.load(this.data.src, this.threeScene, this.camera, this.renderer);

          // 2/3: change animation
          if (this.data.anim) {
            await this.gvrm.changeFBX(this.data.anim);
          }

          this.loaded = true;
        },

        tick: function () {
          if (!this.loaded || !this.gvrm) return;

          // 3/3: update every frame
          this.gvrm.update();
        }
      });
    </script>
  </head>

  <body>
    <a-scene background="color: #222">
      <!-- Simple ground so you see something in the scene -->
      <a-plane position="0 0 -2" rotation="-90 0 0" width="4" height="4" color="#555"></a-plane>

      <!-- Camera -->
      <a-entity position="0 1.6 2">
        <a-camera></a-camera>
      </a-entity>

      <!-- GVRM avatar, loaded by the component -->
      <!-- Rotation is optional, just to face the camera -->
      <a-entity
        gvrm-avatar="src: ./sample.gvrm; anim: ./Idle.fbx"
        rotation="0 180 0">
      </a-entity>
    </a-scene>
  </body>
</html>
