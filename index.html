<!DOCTYPE html>
<head>
  <title>A-Frame GVRM Viewer</title>
  <style>
    body { margin: 0; overflow: hidden; }
  </style>
  
  <!-- CRITICAL: Load A-Frame FIRST -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</head>
<body>
  <a-scene background="color: #222">
    <a-entity camera position="0 1.6 3" look-controls></a-entity>
    <a-entity light="type: directional; intensity: 1" position="1 2 1"></a-entity>
    
    <!-- Avatar container -->
    <a-entity id="avatar-container" position="0 0 -2" rotation="0 180 0">
      <a-animation attribute="rotation" to="0 360 0" dur="10000" repeat="indefinite"></a-animation>
    </a-entity>
    
    <a-plane position="0 0 -3" rotation="-90 0 0" width="10" height="10" material="color: #444"></a-plane>
  </a-scene>

  <!-- YOUR WORKING importmap -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.min.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/",
        "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2.1.0/lib/three-vrm.module.js",
        "gaussian-splats-3d": "https://naruya.github.io/gs-edit/lib/gaussian-splats-3d.module.js",
        "jszip": "https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm",
        "gvrm": "https://naruya.github.io/gs-edit/lib/gaussian-vrm.min.js"
      }
    }
  </script>

  <!-- FIXED: Wait for A-Frame to fully initialize -->
  <script type="module">
    import * as THREE from 'three';
    import { GVRM } from 'gvrm';

    // Wait for A-Frame scene to be FULLY ready
    AFRAME.registerComponent('scene-ready', {
      init: async function() {
        const sceneEl = this.el.sceneEl;
        const avatarEl = document.getElementById('avatar-container');
        
        // Wait for scene loaded + renderer ready
        await new Promise(resolve => {
          if (sceneEl.hasLoaded && sceneEl.renderer) {
            resolve();
          } else {
            sceneEl.addEventListener('loaded', resolve);
          }
        });

        const scene = sceneEl.object3D;
        const camera = sceneEl.camera;
        const renderer = sceneEl.renderer;

        try {
          console.log('üîÑ Loading GVRM...');
          
          // YOUR WORKING CODE - 1/3
          const gvrm = await GVRM.load('./sample.gvrm', scene, camera, renderer);
          
          // YOUR WORKING CODE - 2/3
          await gvrm.changeFBX('./Idle.fbx');
          
          // Attach to A-Frame entity
          avatarEl.object3D.add(gvrm.character.currentVrm.scene);
          
          // YOUR WORKING CODE - 3/3
          renderer.setAnimationLoop(() => {
            gvrm.update();
          });

          console.log('‚úÖ GVRM LOADED IN A-FRAME!');
          
        } catch (error) {
          console.error('‚ùå GVRM failed:', error);
        }
      }
    });
  </script>

<Script>
  <!-- Apply component to scene -->
  window.addEventListener('DOMContentLoaded', () => {
  const scene = document.querySelector('a-scene');
  if (scene.hasLoaded) {
    scene.setAttribute('scene-ready', '');
  } else {
    scene.addEventListener('loaded', () => {
      scene.setAttribute('scene-ready', '');
    });
  }
});
</Script>
</body>
</html>
