<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Aâ€‘Frame + GVRM</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <!-- GVRM + A-Frame glue -->
    <script type="module">
      // Import GVRM directly from the URL you gave earlier
      import { GVRM } from 'https://naruya.github.io/gs-edit/lib/gaussian-vrm.min.js';

      AFRAME.registerComponent('gvrm-avatar', {
        schema: {
          src:  {type: 'string'},              // .gvrm URL
          fbx:  {type: 'string', default: ''}, // .fbx URL (optional)
          scale:{type: 'number', default: 1}
        },

        init: function () {
          this.gvrm = null;
          this._loaded = false;
          this._loadAvatar();
        },

        async _loadAvatar () {
          const el = this.el;
          const sceneEl = el.sceneEl;

          // Wait for A-Frame to create Three.js scene, camera and renderer
          if (!sceneEl.hasLoaded) {
            await new Promise(resolve =>
              sceneEl.addEventListener('loaded', resolve, {once: true})
            );
          }

          const threeScene    = sceneEl.object3D;
          const threeCamera   = sceneEl.camera;
          const threeRenderer = sceneEl.renderer;

          // Load GVRM (this reads sample.gvrm and internally loads model.vrm etc.)
          this.gvrm = await GVRM.load(
            this.data.src,
            threeScene,
            threeCamera,
            threeRenderer
          );

          // Attach the VRM+splats scene under this entity so you can position it.
          const vrmScene = this.gvrm.character.currentVrm.scene;
          vrmScene.scale.setScalar(this.data.scale);
          el.setObject3D('mesh', vrmScene);

          // Optional idle animation
          if (this.data.fbx) {
            await this.gvrm.changeFBX(this.data.fbx);
          }

          this._loaded = true;
          el.emit('gvrm-loaded', {gvrm: this.gvrm}, false);
        },

        tick: function () {
          if (!this._loaded || !this.gvrm) return;
          // Advance VRM and gaussian splats
          this.gvrm.update();
        },

        remove: function () {
          if (this.gvrm) {
            const scene = this.el.sceneEl.object3D;
            // GVRM has a remove(scene) method; we call it to clean up.
            this.gvrm.remove(scene);
            this.gvrm = null;
          }
          this.el.removeObject3D('mesh');
        }
      });
    </script>
  </head>

  <body>
    <a-scene>
      <!-- Camera + light -->
      <a-entity camera position="0 1.6 2"></a-entity>
      <a-entity light="type: directional; intensity: 1" position="1 2 1"></a-entity>

      <!-- Your avatar; note the relative paths -->
      <a-entity
        position="0 0 -2"
        rotation="0 180 0"
        gvrm-avatar="src: ./sample.gvrm; fbx: ./Idle.fbx; scale: 1">
      </a-entity>

      <a-sky color="#222"></a-sky>
    </a-scene>
  </body>
</html>
